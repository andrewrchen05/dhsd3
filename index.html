<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Load d3.js and the geo projection plugin -->
 <!-- Bootstrap CSS -->
 <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">

<script src="https://d3js.org/d3.v4.js"></script>
<script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
<script src="https://d3js.org/queue.v1.min.js"></script>
<!-- <script src="http://d3js.org/d3.geo.projection.v0.min.js"></script> optional, depending on projection -->

<h1>LPR Top 200</h1>

<!-- <select id="form-select" aria-label="Default select example"> -->
  <!-- <option selected="selected">Asian Countries</option> -->
  <!-- <option value="Bangladesh">Bangladesh</option>
  <option value="Bhutan">Bhutan</option>
  <option value="Brunei">Brunei</option>
  <option value="Burma">Burma</option>
  <option value="Cambodia">Cambodia</option> -->
  <!-- <option value="China, People's Republic">China, People's Republic</option>
  <option value="1">Hong Kong</option>
  <option value="2">India</option>
  <option value="3">Indonesia</option>
  <option value="1">Japan</option>
  <option value="2">Korea, North</option>
  <option value="3">Korea, South</option>
  <option value="1">Laos</option>
  <option value="2">Macao</option>
  <option value="3">Malaysia</option>
  <option value="1">Maldives</option>
  <option value="2">Mongolia</option>
  <option value="3">Nepal</option>
  <option value="1">Pakistan</option>
  <option value="2">Philippines</option>
  <option value="3">Singapore</option>
  <option value="1">Sri Lanka</option>
  <option value="2">Taiwan</option>
  <option value="3">Thailand</option>
  <option value="3">Vietnam</option> -->
<!-- </select> -->
<select id="selectButton"></select>
<!-- Button -->
<div>
  <input type="checkbox" class="checkbox" value="EmploymentPreference1st" unchecked><label>Employment Preference 1</label>
  <input type="checkbox" class="checkbox" value="EmploymentPreference2nd" unchecked><label>Employment Preference 2</label>
  <input type="checkbox" class="checkbox" value="EmploymentPreference3rdSkilled" unchecked><label>Employment Preference 3 - Skilled</label>
  <input type="checkbox" class="checkbox" value="EmploymentPreference3rdUnskilled" unchecked><label>Employment Preference 3 - Unskilled</label>
  <input type="checkbox" class="checkbox" value="EmploymentPreference4th" unchecked><label>Employment Preference 4</label>
  <input type="checkbox" class="checkbox" value="EmploymentPreference5th" unchecked><label>Employment Preference 5</label>

  <!-- <input type="checkbox" class="checkbox" value="ImmediateRelativesSpouses" checked><label>Immediate Relatives-Spouses</label>
  <input type="checkbox" class="checkbox" value="ImmediateRelativesChildren" checked><label>Immediate Relatives-Children</label>
  <input type="checkbox" class="checkbox" value="ImmediateRelativesParents" checked><label>Immediate Relatives-Parents</label>

  <input type="checkbox" class="checkbox" value="FamilyPreference1st" checked><label>Family Preference 1</label>
  <input type="checkbox" class="checkbox" value="FamilyPreference2nd" checked><label>Family Preference 2</label>
  <input type="checkbox" class="checkbox" value="FamilyPreference3rd" checked><label>Family Preference 3</label>
  <input type="checkbox" class="checkbox" value="FamilyPreference4th" checked><label>Family Preference 4</label>

  <input type="checkbox" class="checkbox" value="RefugeeandAsyleeAdjustments" checked><label>Refugee and Asylee Adjustments</label>
  <input type="checkbox" class="checkbox" value="Other" checked><label>Other</label>
  <input type="checkbox" class="checkbox" value="DiversityProgram" checked><label>Diversity Program</label> -->
</div>

<!-- Create an element where the map will take place -->
<!-- <svg id="my_dataviz" width="500" height="500"></svg> -->
<div id="my_dataviz"></div>

<style>
.circle:hover{
    stroke: black;
    stroke-width: 4px;
}

.legend circle {
  fill: none;
  stroke: #ccc;
}

.legend text {
  fill: #777;
  font: 10px sans-serif;
  text-anchor: middle;
}
</style>

<script>

    var width = 750
    var height = 750
    
    // The svg
    var svg, svg1
    svg = svg1 = d3.select("#my_dataviz")
      .append("svg")
      .attr("width", width)
      .attr("height", height)

    var projection = d3.geoAlbersUsa()
        .scale(1000)                       // This is like the zoom
        .translate([ width/2, height/2 ])

  var data = d3.csv("data/sheet.csv", function(data) {
    // var markers

    // var elem = document.getElementById('form-select');
    // elem.addEventListener("change", onSelectChange)
    // onSelectChange()

    // function onSelectChange(){
    //   var value = this.value;
    //   selected_country = document.getElementById('form-select').value
    //   console.log("Selected country: " + selected_country)
       

      markers = data.filter(function(d) { 

        if( 
          (d["MajorClassAdmission"] == "EmploymentPreference1st" || d["MajorClassAdmission"] == "EmploymentPreference2nd" 
            || d["MajorClassAdmission"] == "EmploymentPreference3rdSkilled" || d["MajorClassAdmission"] == "EmploymentPreference3rdUnskilled"
            || d["MajorClassAdmission"] == "EmploymentPreference4th" || d["MajorClassAdmission"] == "EmploymentPreference5th"
            ) 
            // && 
            // d["CountryofBirth"]=="Bangladesh"
            && d["Admissions"] != "D" && d["lon"] != "NA" && d["lat"] != "NA") { 
          return d;
        } 
      })
      console.log(markers)
    //}
    //elem.addEventListener("change", onSelectChange)
    // Load external data and boot
    d3.json("gz_2010_us_040_00_20m.json", function(data){

      var allGroup = ["", "Bangladesh", "Bhutan", "Brunei", "Burma", "Cambodia"]

          // add the options to the button
        d3.select("#selectButton")
          .selectAll('myOptions')
          .data(allGroup)
          .enter()
          .append('option')
          .text(function (d) { return d; }) // text showed in the menu
          .attr("value", function (d) { return d; }) // corresponding value returned by the button
    
        // Create a color scale
        var color = d3.scaleOrdinal()
          .domain(["EmploymentPreference1st", "EmploymentPreference2nd", "EmploymentPreference3rdSkilled", "EmploymentPreference3rdUnskilled"
            , "EmploymentPreference4th", "EmploymentPreference5th"])
          //.range([ "#402D54", "#D18975", "#8FD175"])
          .range(d3.schemeCategory10)
    
        // Add a scale for bubble size
        var size = d3.scaleLinear()
          .domain([1,200])  // What's in the data
          .range([ 4, 50])  // Size in pixel

        // var path = d3.geo.path().projection(null)
    
        //Draw the map

        // svg.append("g")
        //     .selectAll("path")
        //     .data(data.features)
        //     .enter()
        //     .append("path")
        //       .attr("fill", "#b8b8b8")
        //       .attr("d", d3.geoPath()
        //           .projection(projection)
        //       )
        //     .style("stroke", "black")
        //     .style("opacity", .3)

        //var layer1 = svg

        //create a tooltip (hover information)
        var Tooltip = d3.select("#my_dataviz")
          .append("div")
          .attr("class", "tooltip")
          .style("opacity", 1)
          .style("background-color", "white")
          .style("border", "solid")
          .style("border-width", "2px")
          .style("border-radius", "5px")
          .style("padding", "5px")
    
        // Three function that change the tooltip when user hover / move / leave a cell
        var mouseover = function(d) {
          Tooltip.style("opacity", 1)
        }
        var mousemove = function(d) {
          Tooltip
            .html(d.CountyState + "<br>" + "long: " + d.lon + "<br>" + "lat: " + d.lat + "<br>" + "Admissions: " + d.Admissions)
            .style("left", (d3.mouse(this)[0]+10) + "px")
            .style("top", (d3.mouse(this)[1]) + "px")
        }
        var mouseleave = function(d) {
          Tooltip.style("opacity", 0)
        }

        // use temp variable
        function update_country() {
          var selected_country = document.getElementById('form-select').value
          console.log("Selected country: " + selected_country)
          //return selected_country
          var datamarkers = markers.filter(function(d) {
            return d["CountryofBirth"] == selected_country
          })
          console.log(datamarkers)
          return datamarkers
        }

        //var datamarkers = update_country()
        //circles()
        // Add circles:
        //function circles() {

          // svg
          //   .selectAll("myCircles")
          //   //.data(update_country())
          //   .enter()
          //   .append("circle")
          //     .attr("class" , function(d){ return (d.MajorClassAdmission) })
          //     .attr("cx", function(d){ return projection([d.lon, d.lat])[0] })
          //     .attr("cy", function(d){ return projection([d.lon, d.lat])[1] })
          //     .attr("r", function(d){ return d.Admissions })
          //     .style("fill", function(d){ return color(d.MajorClassAdmission) })
          //     .attr("stroke", function(d){ return color(d.MajorClassAdmission) })
          //     .attr("stroke-width", 3)
          //     .attr("fill-opacity", .4)
          //   .on("mouseover", mouseover)
          //   .on("mousemove", mousemove)
          //   .on("mouseleave", mouseleave)
        makeMap()
        
        function makeMap() {
          svg.append("g")
            .selectAll("path")
            .data(data.features)
            .enter()
            .append("path")
              .attr("fill", "#b8b8b8")
              .attr("d", d3.geoPath()
                  .projection(projection)
              )
            .style("stroke", "black")
            .style("opacity", .3)

          // svg
          //   .selectAll("myCircles")
          //   //.data(update_country())
          //   .enter()
          //   .append("circle")
          //     .attr("class" , function(d){ return (d.MajorClassAdmission) })
          //     .attr("cx", function(d){ return projection([d.lon, d.lat])[0] })
          //     .attr("cy", function(d){ return projection([d.lon, d.lat])[1] })
          //     .attr("r", function(d){ return d.Admissions })
          //     .style("fill", function(d){ return color(d.MajorClassAdmission) })
          //     .attr("stroke", function(d){ return color(d.MajorClassAdmission) })
          //     .attr("stroke-width", 3)
          //     .attr("fill-opacity", .4)
          //   .on("mouseover", mouseover)
          //   .on("mousemove", mousemove)
          //   .on("mouseleave", mouseleave)
        }


        function update(){   
          

          d3.selectAll(".checkbox").each(function(d){
            cb = d3.select(this);
            group = cb.property("value")
    
            // If the box is check, I show the group
            if(cb.property("checked")){
                //console.log("checked")
                svg.selectAll("."+group).transition().duration(1000).style("opacity", 1).attr("r", function(d){ return d.Admissions })
    
            // Otherwise I hide it
            }else{
                //console.log("unchecked")
                svg.selectAll("."+group).transition().duration(1000).style("opacity", 0).attr("r", 0)
            }
            //circles()
          })
        }

        function updatecountry(selectedGroup) {
          
          // Create new data with the selection?
          var datamarkers = markers.filter(function(d) {
            return d["CountryofBirth"] == selectedGroup
          })
          console.log(datamarkers)

          d3.selectAll("circle").remove()
          //svg.remove()

          svg
          .selectAll("myCircles")
          .data(datamarkers)
            //.sort(function(a, b) { return b.properties.Admissions - a.properties.Admissions}))
          .enter()
          .append("circle")
              .attr("class" , function(d){ return (d.MajorClassAdmission) })
              .attr("cx", function(d){ return projection([d.lon, d.lat])[0] })
              .attr("cy", function(d){ return projection([d.lon, d.lat])[1] })
              .attr("r", function(d){ return d.Admissions })
              .style("fill", function(d){ return color(d.MajorClassAdmission) })
              .attr("stroke", function(d){ return color(d.MajorClassAdmission) })
              .attr("stroke-width", 3)
              .attr("fill-opacity", .4)
            .on("mouseover", mouseover)
            .on("mousemove", mousemove)
            .on("mouseleave", mouseleave)

          }
    
        // When a button change, I run the update function
        d3.selectAll(".checkbox").on("change",update)
        // d3.selectAll("#form-select").on("change", function() {
        //   svg.data(update_country())
        //   //circles()
        //   //datamarkers = update_country()
        // })
        // And I initialize it at the beginning
        update()
        //begin()

        d3.select("#selectButton").on("change", function(d) {
          // recover the option that has been chosen
          var selectedOption = d3.select(this).property("value")
          // run the updateChart function with this selected option
          updatecountry(selectedOption)
        })
    })

  })
    
</script>

