<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js and the geo projection plugin -->
<script src="https://d3js.org/d3.v4.js"></script>
<script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>

<h1>LPR Top 200 Bangladesh</h1>

<!-- Button -->
<div>
  <input type="checkbox" class="checkbox" value="EmploymentPreference1st" checked><label>Employment Preference 1</label>
  <input type="checkbox" class="checkbox" value="EmploymentPreference2nd" checked><label>Employment Preference 2</label>
  <input type="checkbox" class="checkbox" value="EmploymentPreference3rd" checked><label>Employment Preference 3</label>
</div>

<!-- Create an element where the map will take place -->
<!-- <svg id="my_dataviz" width="500" height="500"></svg> -->
<div id="my_dataviz"></div>

<style>
.circle:hover{
    stroke: black;
    stroke-width: 4px;
}

.legend circle {
  fill: none;
  stroke: #ccc;
}

.legend text {
  fill: #777;
  font: 10px sans-serif;
  text-anchor: middle;
}
</style>

<script>

    // The svg
    // var svg = d3.select("svg"),
    //     width = +svg.attr("width"),
    //     height = +svg.attr("height");
    // Size ?
    var width = 750
    var height = 750
    
    // The svg
    var svg = d3.select("#my_dataviz")
      .append("svg")
      .attr("width", width)
      .attr("height", height)
    
    // Map and projection
    // Map and projection
    var projection = d3.geoMercator()
        .center([-100, 30])                // GPS of location to zoom on
        .scale(250)                       // This is like the zoom
        .translate([ width/2, height/2 ])
    
    // Create data for circles:
    // var markers = [
    //   {long: -74, lat: 42.149, name: "New York", group: "A", size: 34}, 
    //   {long: -95.3102505, lat: 29.7751825, name: "Harris County, TX", group: "A", size: 14}, 
    //   {long: -95.940971, lat: 36.1593471, name: "Tulsa County,  Oklahoma", group: "B", size: 87}, 
    //   {long: -80.8543847, lat: 35.2632655, name: "Mecklenburg County,  North Carolina", group: "B", size: 41}, 
    //   {long: -87.9065334, lat: 43.0387949, name: "Milwaukee County,  Wisconsin", group: "C", size: 78}, 
    //   {long: -76.7336521, lat: 40.2734277, name: "Dauphin County,  Pennsylvania", group: "C", size: 12}, 
    // ];
    // var csv = "finalsheet.csv"

    // var markers = d3.csvParse(csv);
    // markers.filter(function(d) {
    //   return d["Country-of-Birth"] == "Bangladesh"
    // })
    // console.log(markers)

  var data = d3.csv("finalsheet.csv", function(data) {

    var markers = data.filter(function(d) { 

      if( 
        (d["MajorClassAdmission"] == "EmploymentPreference1st" 
          || d["MajorClassAdmission"] == "EmploymentPreference2nd" 
          || d["MajorClassAdmission"] == "EmploymentPreference3rd") 
          && d["CountryofBirth"]=="Bangladesh" && d["Admissions"] != "D" && d["lon"] != "NA" && d["lat"] != "NA") { 
        return d;
      } 
    })
    console.log(markers)
    
    
    // Load external data and boot
    //d3.json("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson", function(data){
    d3.json("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson", function(data){
    
        // Filter data
        //data.features = data.features.filter( function(d){return d.properties.name=="USA"} )
        data.features = data.features.filter( function(d){return d.properties.name=="USA"} )
    
        // Create a color scale
        var color = d3.scaleOrdinal()
          .domain(["EmploymentPreference1st", "EmploymentPreference2nd", "EmploymentPreference3rd" ])
          .range([ "#402D54", "#D18975", "#8FD175"])
    
        // Add a scale for bubble size
        var size = d3.scaleLinear()
          .domain([1,100])  // What's in the data
          .range([ 4, 50])  // Size in pixel
    
        // Draw the map
        svg.append("g")
            .selectAll("path")
            .data(data.features)
            .enter()
            .append("path")
              .attr("fill", "#b8b8b8")
              .attr("d", d3.geoPath()
                  .projection(projection)
              )
            .style("stroke", "black")
            .style("opacity", .3)

        //create a tooltip (hover information)
        var Tooltip = d3.select("#my_dataviz")
          .append("div")
          .attr("class", "tooltip")
          .style("opacity", 1)
          .style("background-color", "white")
          .style("border", "solid")
          .style("border-width", "2px")
          .style("border-radius", "5px")
          .style("padding", "5px")
    
        // Three function that change the tooltip when user hover / move / leave a cell
        var mouseover = function(d) {
          Tooltip.style("opacity", 1)
        }
        var mousemove = function(d) {
          Tooltip
            .html(d.CountyState + "<br>" + "long: " + d.lon + "<br>" + "lat: " + d.lat + "<br>" + "Admissions: " + d.Admissions)
            .style("left", (d3.mouse(this)[0]+10) + "px")
            .style("top", (d3.mouse(this)[1]) + "px")
        }
        var mouseleave = function(d) {
          Tooltip.style("opacity", 0)
        }
    
        // Add circles:
        svg
          .selectAll("myCircles")
          .data(markers)
          .enter()
          .append("circle")
            .attr("class" , function(d){ return (d.MajorClassAdmission) })
            .attr("cx", function(d){ return projection([d.lon, d.lat])[0] })
            .attr("cy", function(d){ return projection([d.lon, d.lat])[1] })
            .attr("r", function(d){ return d.Admissions })
            .style("fill", function(d){ return color(d.MajorClassAdmission) })
            .attr("stroke", function(d){ return color(d.MajorClassAdmission) })
            .attr("stroke-width", 3)
            .attr("fill-opacity", .4)
          .on("mouseover", mouseover)
          .on("mousemove", mousemove)
          .on("mouseleave", mouseleave)
    
        // This function is gonna change the opacity and size of selected and unselected circles
        function update(){
    
          // For each check box:
          d3.selectAll(".checkbox").each(function(d){
            cb = d3.select(this);
            group = cb.property("value")
            //console.log(group)
    
            // If the box is check, I show the group
            if(cb.property("checked")){
                //console.log("checked")
                svg.selectAll("."+group).transition().duration(1000).style("opacity", 1).attr("r", function(d){ return d.Admissions })
    
            // Otherwise I hide it
            }else{
                //console.log("unchecked")
                svg.selectAll("."+group).transition().duration(1000).style("opacity", 0).attr("r", 0)
            }
          })
        }
    
        // When a button change, I run the update function
        d3.selectAll(".checkbox").on("change",update)
        
        // And I initialize it at the beginning
        update()
    })

  })
    
</script>

